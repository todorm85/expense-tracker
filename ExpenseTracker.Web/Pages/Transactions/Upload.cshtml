@page
@model ExpenseTracker.Web.Pages.Transactions.UploadModel

<form enctype="multipart/form-data" method="post" onkeydown="return event.key != 'Enter';">
    @if (@Model.ViewData["errorMessage"] != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill"></i> Error: @Model.ViewData["errorMessage"]
        </div>
    }
    
    @if (@Model.ViewData["successMessage"] != null)
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill"></i> @Model.ViewData["successMessage"]
        </div>
    }
    
    @if (@Model.ViewData["warningMessage"] != null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ViewData["warningMessage"]
        </div>
    }

    <partial name="_Exceptions" for="ImportExceptions" />

    <input type="hidden" asp-for="NewTransaction.TransactionId" />
    <input type="hidden" asp-for="NewTransaction.Source" />

    @if (Model.JustAddedTransactions.Transactions.Any())
    {
        <h3 class="d-inline">Just Added</h3>
        <a type="submit" asp-page-handler="ClearAdded">Clear</a>
        var heigth = 3;
        Model.JustAddedTransactions.DetailsHeight = heigth;
        Model.SkippedTransactions.DetailsHeight = heigth;
        <partial name="_TransactionsList" for="JustAddedTransactions" />
        <button type="submit" asp-page-handler="UpdateAllTransaction" class="btn-success">Update All</button>

        <hr />
    }

    @if (Model.SkippedTransactions.Transactions.Any())
    {
        <div class="row">
            <div class="col">
                <h3 class="d-inline">Skipped</h3>
                <a type="submit" asp-page-handler="ClearSkipped">Clear</a>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <partial name="_TransactionsList" for="SkippedTransactions" />
            </div>
        </div>
    }

    @if (Model.HasMail)
    {
        <div class="mycard">
            <h2>Sync from Gmail</h2>
            <div class="d-flex flex-column align-items-start">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" asp-for="DeleteMailAfterImport" id="deleteMailAfterImport">
                    <label class="form-check-label" for="deleteMailAfterImport">
                        Delete emails after import
                    </label>
                </div>
                <button class="btn btn-primary" type="submit" asp-page-handler="SyncMail">Sync</button>
            </div>
        </div>
    }

    <div class="mycard">
        <h2>
            Manual Entry
        </h2>

        <div class="row">
            <div class="form-group col">
                <label for="date">Date</label>
                <input id="date" type="date" asp-for="NewTransaction.Date" class="form-control" />
            </div>
            <div class="form-group col">
                <label for="amount">Amount</label>
                <input id="amount" onmouseup="return false;" asp-for="NewTransaction.Amount" class="form-control auto-select" />
            </div>
        </div>

        <div class="row">
            <div class="form-group col">
                <label for="category">Category</label>
                <input id="category" asp-for="NewTransaction.Category" class="form-control col" placeholder="name:key(opt)" onkeyup="onCreateEnter(event)" list="cats" autocomplete="off" />
                <vc:categories-data-list id="cats"></vc:categories-data-list>
            </div>
            <div class="form-group col">
                <label for="type">Type</label>
                <select id="type" class="form-control col" asp-for="NewTransaction.Type" asp-items="Html.GetEnumSelectList<ExpenseTracker.Core.Transactions.TransactionType>()"></select>
            </div>
        </div>

        <div class="form-group">
            <label for="details">Details</label>
            <textarea id="details" asp-for="NewTransaction.Details" rows="4" class="form-control" onkeyup="onCreateEnter(event)"></textarea>
        </div>

        <button class="btn btn-primary" type="submit" id="submitBtn" asp-page-handler="create">Save</button>

    </div>

    <div class="mycard">
        <h2>
            Upload File
        </h2>

        <div class="form-group">
            <input class="form-control-file my-2" id="files" type="file" multiple asp-for="Files" />
            <button asp-page-handler="Upload" type="submit" value="Upload" class="btn btn-primary">Upload</button>
        </div>
    </div>

    <div class="mycard">
        <h2 class="card-title">Import Trading212 JSON</h2>
        <div class="form-group">
            <label for="Trading212Json" class="form-label">Trading212 Transaction JSON</label>
            <textarea asp-for="@Model.Trading212Json" class="form-control" id="Trading212Json" rows="6" placeholder="Paste Trading212 transaction JSON here..."></textarea>
        </div>

        <div class="form-group">
            <p>
                <a class="btn btn-link p-0" data-toggle="collapse" href="#trading212Instructions" role="button" aria-expanded="false" aria-controls="trading212Instructions">
                    <i class="bi bi-info-circle"></i> How to get Trading212 transaction JSON
                </a>
            </p>
            <div class="collapse" id="trading212Instructions">
                <div class="card card-body bg-light">
                    <h5>How to extract Trading212 transaction data:</h5>
                    <ol>
                        <li>Login to your Trading212 account</li>
                        <li>Go to History &gt; Transactions</li>
                        <li>Open browser developer tools (F12 or right-click &gt; Inspect)</li>
                        <li>Go to the Network tab</li>
                        <li>Filter for "transaction-executions"</li>
                        <li>Refresh the page or navigate through transaction pages</li>
                        <li>Find the API request and click on it</li>
                        <li>In the Response tab, copy the entire JSON array</li>
                        <li>Paste it into the text area above</li>
                    </ol>
                    <p class="mb-0"><small>This allows you to import transactions without storing your Trading212 credentials.</small></p>
                </div>
            </div>
              <p class="mt-3">
                <a class="btn btn-link p-0" data-toggle="collapse" href="#trading212JsonFormat" role="button" aria-expanded="false" aria-controls="trading212JsonFormat">
                    <i class="bi bi-info-circle"></i> Expected JSON format
                </a>
            </p>
            <div class="collapse" id="trading212JsonFormat">
                <div class="card card-body bg-light">
                    <h5>Trading212 JSON Format:</h5>
                    <p>The JSON should be an array of transaction objects containing at least:</p>
                    <pre class="mb-2"><code>[
  {
    "id": 123456789,
    "amount": 25.99,
    "timeCreated": "2025-05-24T15:30:45.000Z",
    "type": "PURCHASE",
    "status": "COMPLETED",
    "cardLastFour": "1234",
    "merchant": {
      "name": "Store Name",
      "category": "Shopping",
      "address": "123 Main St",
      "countryCode": "US"
    }
  },
  ...
]</code></pre>
                    <p class="mb-0"><small>Only transactions with type "PURCHASE" and status "COMPLETED" or "PENDING" will be imported.</small></p>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button asp-page-handler="Trading212Json" type="submit" class="btn btn-primary">
                Process JSON
            </button>
        </div>
    </div>

</form>

@section Scripts {
    <script>
        window.onload = function () {
            document.getElementById("amount").focus();
        }

        function onCreateEnter(e) {
            if (e.isComposing || e.keyCode === 229)
                return;
            e.stopPropagation();
            if (e.keyCode === 13) {
                var btn = document.getElementById("submitBtn");
                btn.click();
            }
        }
    </script>
}